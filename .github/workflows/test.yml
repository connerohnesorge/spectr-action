name: "test"

on:
  workflow_dispatch:
  pull_request:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  lint-and-build:
    name: Lint and Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Node 20
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run check

      - name: Build action
        run: npm run build

      - name: Package action
        run: npm run package

      - name: Check for uncommitted changes
        run: |
          git diff --exit-code || (echo "::error::Please run 'npm run build' and commit the changes" && exit 1)

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Node 20
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

  test-valid-project:
    name: Test Valid Project (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: lint-and-build
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Copy valid fixture to root
        shell: bash
        run: |
          rm -rf ./spectr && cp -r __tests__/fixtures/valid-spectr-project/spectr ./spectr

      - name: Run spectr-action
        uses: ./
        with:
          version: latest
          strict: true

  test-valid-with-changes:
    name: Test Valid Project with Changes (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: lint-and-build
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Copy fixture with changes to root
        shell: bash
        run: |
          rm -rf ./spectr && cp -r __tests__/fixtures/valid-with-changes/spectr ./spectr

      - name: Run spectr-action in strict mode
        uses: ./
        with:
          version: latest
          strict: true

  test-multi-capability:
    name: Test Multi-Capability Project
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Copy multi-capability fixture to root
        shell: bash
        run: |
          rm -rf ./spectr && cp -r __tests__/fixtures/multi-capability/spectr ./spectr

      - name: Run spectr-action
        uses: ./
        with:
          version: latest
          strict: true

  test-invalid-project:
    name: Test Invalid Project (Missing Scenarios)
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run spectr-action (should fail gracefully)
        id: spectr-validation
        continue-on-error: true
        uses: ./__tests__/fixtures/invalid-missing-scenarios/
        with:
          version: latest
          strict: true

      - name: Verify validation failed
        shell: bash
        run: |
          if [ "${{ steps.spectr-validation.outcome }}" == "success" ]; then
            echo "::error::Expected validation to fail for invalid project"
            exit 1
          fi
          echo "Validation correctly failed for invalid project"

  test-invalid-malformed:
    name: Test Invalid Project (Malformed Spec)
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run spectr-action (should fail gracefully)
        id: spectr-validation
        continue-on-error: true
        uses: ./__tests__/fixtures/invalid-malformed-spec/
        with:
          version: latest
          strict: true

      - name: Verify validation failed
        shell: bash
        run: |
          if [ "${{ steps.spectr-validation.outcome }}" == "success" ]; then
            echo "::error::Expected validation to fail for malformed spec"
            exit 1
          fi
          echo "Validation correctly failed for malformed spec"

  test-strict-mode:
    name: Test Strict Mode Toggle
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Copy invalid fixture to root
        shell: bash
        run: |
          rm -rf ./spectr && cp -r __tests__/fixtures/invalid-missing-scenarios/spectr ./spectr

      - name: Run spectr-action with strict mode disabled
        uses: ./
        with:
          version: latest
          strict: false

  test-empty-project:
    name: Test Empty Spectr Project
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Copy empty fixture to root
        shell: bash
        run: |
          rm -rf ./spectr && cp -r __tests__/fixtures/empty-spectr-project/spectr ./spectr

      - name: Run spectr-action on empty project
        uses: ./
        with:
          version: latest
          strict: true

  test-version-resolution:
    name: Test Version Resolution
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Copy valid fixture to root
        shell: bash
        run: |
          rm -rf ./spectr && cp -r __tests__/fixtures/valid-spectr-project/spectr ./spectr

      - name: Test with latest version
        uses: ./
        with:
          version: latest
          strict: true

  validate-spectr:
    name: Validate Spectr (Dogfood)
    runs-on: ubuntu-latest
    needs: lint-and-build
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run spectr-action on repository's own spectr directory
        uses: ./
        with:
          version: latest
          strict: true

  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs:
      - lint-and-build
      - unit-tests
      - test-valid-project
      - test-valid-with-changes
      - test-multi-capability
      - test-invalid-project
      - test-invalid-malformed
      - test-strict-mode
      - test-empty-project
      - test-version-resolution
      - validate-spectr
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          echo "All jobs passed: ${{ !(contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')) }}"
          exit ${{ (contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')) && 1 || 0 }}
